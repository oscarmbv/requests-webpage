{% extends "base.html" %}
{% load tz %}
{% load static %}
{% load i18n %}
{% load duration_filters %}
{% load custom_filters %}

{% block title %}{% trans "Request Details:" %} {{ user_request.unique_code }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    dl dt { font-weight: bold; }
    .pre-wrap { white-space: pre-wrap; word-wrap: break-word; }
    .url-break { word-break: break-all; }
     .invalid-feedback { width: 100%; margin-top: .25rem; font-size: .875em; color: var(--bs-danger-text-emphasis); }
     .invalid-feedback.d-none { display: none; }
     .invalid-feedback:not(.d-none) { display: block; }
</style>
{% endblock %}


{% block content %}
<div class="container mt-4">

    {# --- Cabecera con ID y Estado --- #}
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <h1 class="h3">{% trans "Request Details" %}</h1>
        <div>
            <span class="me-2 text-muted">ID: {{ user_request.unique_code }}</span>
            <span class="badge fs-6 rounded-pill
                {% if user_request.status == 'pending' %}text-bg-primary{% endif %}
                {% if user_request.status == 'scheduled' %}text-bg-secondary{% endif %}
                {% if user_request.status == 'in_progress' %}text-bg-warning{% endif %}
                {% if user_request.status == 'update_requested' %}text-bg-info{% endif %}
                {% if user_request.status == 'qa_pending' %}text-bg-primary{% endif %}
                {% if user_request.status == 'qa_in_progress' %}text-bg-warning{% endif %}
                {% if user_request.status == 'blocked' %}text-bg-dark{% endif %}
                {% if user_request.status == 'pending_approval' %}text-bg-info{% endif %}
                {% if user_request.status == 'completed' %}text-bg-success{% endif %}
                {% if user_request.status == 'cancelled' %}text-bg-secondary{% endif %}
            ">{{ user_request.get_status_display }}</span>
        </div>
    </div>

    {% if user_request.update_needed_flag and user_request.status not in "scheduled completed cancelled" %}
        <div class="alert alert-info d-flex align-items-center p-2 mb-3" role="alert">
          <i class="bi bi-info-circle-fill me-2"></i>
          <div>
            <strong>{% trans "Provide Progress Update:" %}</strong> {% trans "An update has been requested for this task." %}
            {% comment %} Mostrar quién y cuándo si la información está disponible {% endcomment %}
            {% if user_request.update_requested_by %}
                <br><small class="text-muted">
                    ({% trans "Requested by" %} {{ user_request.update_requested_by.get_full_name|default:user_request.update_requested_by.email|default:user_request.update_requested_by.username }}
                    {% if user_request.update_requested_at %}
                        {% trans "on" %} {% timezone request.user.timezone|default:"UTC" %}{{ user_request.update_requested_at|date:"Y-m-d H:i" }}{% endtimezone %}
                    {% endif %})
                </small>
            {% endif %}
          </div>
        </div>
    {% endif %}

    {% if user_request.status == 'blocked' %}
        <div class="alert alert-danger d-flex align-items-center p-2 mb-3" role="alert">
            <i class="bi bi-sign-stop-fill me-2"></i>
            <div>
                <strong>{% trans "Request Blocked:" %}</strong> {% trans "This request is currently blocked and requires resolution before proceeding." %}
                {% with last_block=blocked_history.first %}
                    {% if last_block %}
                        <br><small class="text-muted">{% trans "Reason:" %} {{ last_block.reason|clean_for_plaintext|truncatewords:20 }}
                        ({% trans "Blocked by" %} {{ last_block.blocked_by.email|default:"System" }} {% trans "on" %} {% timezone request.user.timezone|default:"UTC" %}{{ last_block.blocked_at|date:"Y-m-d H:i" }}{% endtimezone %})</small>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
    {% endif %}

    {% if user_request.cancelled and user_request.cancelled_by %}
        <div class="alert alert-warning d-flex align-items-center p-2 mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> {# Ícono de advertencia o cancelación #}
            <div>
                <strong>{% trans "Request Cancelled:" %}</strong> {% trans "This request is currently cancelled." %}
                <br><small class="text-muted">
                    ({% trans "Cancelled by" %} {{ user_request.cancelled_by.get_full_name|default:user_request.cancelled_by.email|default:user_request.cancelled_by.username }}
                    {% if user_request.cancelled_at %}
                        {% trans "on" %} {% timezone request.user.timezone|default:"UTC" %}{{ user_request.cancelled_at|date:"Y-m-d H:i" }}{% endtimezone %}
                    {% endif %})
                </small>
            </div>
        </div>
    {% endif %}

    {% if not user_request.cancelled and user_request.status == 'pending' and user_request.uncanceled_by %}
        <div class="alert alert-info d-flex align-items-center p-2 mb-3" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i> {# Ícono de información #}
            <div>
                <strong>{% trans "Request Un-cancelled:" %}</strong> {% trans "This request was un-cancelled and is awaiting processing." %}
                <br><small class="text-muted">
                    ({% trans "Un-cancelled by" %} {{ user_request.uncanceled_by.get_full_name|default:user_request.uncanceled_by.email|default:user_request.uncanceled_by.username }}
                    {% if user_request.uncanceled_at %}
                        {% trans "on" %} {% timezone request.user.timezone|default:"UTC" %}{{ user_request.uncanceled_at|date:"Y-m-d H:i" }}{% endtimezone %}
                    {% endif %})
                </small>
            </div>
        </div>
    {% endif %}

    {% if user_request.is_rejected_previously and user_request.status in "in_progress pending" %}
        <div class="alert alert-warning d-flex align-items-center p-2 mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>{% trans "Action Required:" %}</strong> {% trans "This request was previously rejected by QA and requires corrections before it can be sent back to QA." %}
                 {% with last_rejection=rejected_history.first %}
                    {% if last_rejection %}
                        <br><small class="text-muted">{% trans "Last Rejection Reason:" %} {{ last_rejection.reason|truncatewords:20 }}
                        ({% trans "Rejected by" %} {{ last_rejection.rejected_by.email|default:"System" }} {% trans "on" %} {% timezone request.user.timezone|default:"UTC" %}{{ last_rejection.rejected_at|date:"Y-m-d H:i" }}{% endtimezone %})</small>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
    {% endif %}

    {% if user_request.status == 'scheduled' and user_request.scheduled_date %}
        <div class="alert alert-secondary d-flex align-items-center p-2 mb-3" role="alert">
            <i class="bi bi-calendar-event-fill me-2"></i>
            <div>
                <strong>This request is scheduled for:</strong> {{ user_request.scheduled_date|date:"Y-m-d" }}.
                It will become active (Pending) on this date.
            </div>
        </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header"> {% trans "Request Information" %} </div>
                <div class="card-body">
                    <dl>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Priority:" %}</dt> <dd class="col-sm-7"> <span class="badge rounded-pill {% if user_request.priority == 'low' %}text-bg-secondary{% endif %} {% if user_request.priority == 'normal' %}text-bg-primary{% endif %} {% if user_request.priority == 'high' %}text-bg-danger{% endif %} {% if not user_request.priority %}text-bg-primary{% endif %} "> {{ user_request.get_priority_display|default:"Normal" }} </span> </dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Type:" %}</dt> <dd class="col-sm-7">{{ user_request.get_type_of_process_display }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Assigned Team:" %}</dt> <dd class="col-sm-7">{{ user_request.get_team_display|default:"Unassigned" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Requested By:" %}</dt> <dd class="col-sm-7">{{ user_request.requested_by.email|default:"N/A" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Requested At:" %}</dt>
                            <dd class="col-sm-7">
                                {% timezone request.user.timezone|default:"UTC" %}
                                    {{ user_request.timestamp|date:"Y-m-d H:i:s" }}
                                {% endtimezone %}
                                ({{ request.user.timezone|default:"UTC" }})
                            </dd>
                        </div>
                        {% if user_request.status == 'scheduled' and user_request.scheduled_date %}
                            <div class="alert alert-secondary d-flex align-items-center p-2 mb-3" role="alert">
                                <i class="bi bi-calendar-event-fill me-2"></i>
                                <div>
                                    <strong>{% trans "Scheduled Activation:" %}</strong>
                                    {% blocktrans with date=user_request.scheduled_date|date:"Y-m-d" %}
                                        This request is scheduled to activate on <strong>{{ date }}</strong>. It will become 'Pending' on this date.
                                    {% endblocktrans %}
                                </div>
                            </div>
                        {% endif %}
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Operator:" %}</dt> <dd class="col-sm-7">{{ user_request.operator.email|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Operated At:" %}</dt>
                            <dd class="col-sm-7">
                                {% if user_request.operated_at %}
                                    {% timezone request.user.timezone|default:"UTC" %}
                                        {{ user_request.operated_at|date:"Y-m-d H:i:s" }}
                                    {% endtimezone %}
                                    ({{ request.user.timezone|default:"UTC" }})
                                {% else %}-{% endif %}
                            </dd>
                        </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "QA Agent:" %}</dt> <dd class="col-sm-7">{{ user_request.qa_agent.email|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Sent to QA At:" %}</dt>
                            <dd class="col-sm-7">
                                {% if user_request.qa_pending_at %}
                                    {% timezone request.user.timezone|default:"UTC" %}
                                        {{ user_request.qa_pending_at|date:"Y-m-d H:i:s" }}
                                    {% endtimezone %}
                                    ({{ request.user.timezone|default:"UTC" }})
                                {% else %}-{% endif %}
                            </dd>
                        </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "QA Started At:" %}</dt>
                            <dd class="col-sm-7">
                                {% if user_request.qa_in_progress_at %}
                                    {% timezone request.user.timezone|default:"UTC" %}
                                        {{ user_request.qa_in_progress_at|date:"Y-m-d H:i:s" }}
                                    {% endtimezone %}
                                    ({{ request.user.timezone|default:"UTC" }})
                                {% else %}-{% endif %}
                            </dd>
                        </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Completed At:" %}</dt>
                            <dd class="col-sm-7">
                                {% if user_request.completed_at %}
                                    {% timezone request.user.timezone|default:"UTC" %}
                                        {{ user_request.completed_at|date:"Y-m-d H:i:s" }}
                                    {% endtimezone %}
                                    ({{ request.user.timezone|default:"UTC" }})
                                {% else %}-{% endif %}
                            </dd>
                        </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Cancelled At:" %}</dt>
                            <dd class="col-sm-7">
                                {% if user_request.cancelled_at %}
                                    {% timezone request.user.timezone|default:"UTC" %}
                                        {{ user_request.cancelled_at|date:"Y-m-d H:i:s" }}
                                    {% endtimezone %}
                                    ({{ request.user.timezone|default:"UTC" }})
                                {% else %}-{% endif %}
                            </dd>
                        </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Turn Around Time:" %}</dt>
                            <dd class="col-sm-7">
                                {% with tat_value=user_request.calculated_turn_around_time %}
                                    {% if tat_value is not None %}
                                        {{ tat_value|format_timedelta }} {# <--- USAR EL FILTRO AQUÍ #}
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endwith %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>

        {# --- Columna Derecha: Detalles específicos y Operación --- #}
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                 <div class="card-header"> {% trans "Submission Details (Unit Transfer)" %} </div>
                <div class="card-body">
                    <dl>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Transfer Type:" %}</dt><dd class="col-sm-7">{{ user_request.get_unit_transfer_type_display|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Partner (Origin):" %}</dt><dd class="col-sm-7">{{ user_request.partner_name|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Properties Affected:" %}</dt><dd class="col-sm-7 pre-wrap">{{ user_request.properties|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "New Partner/Prospect:" %}</dt><dd class="col-sm-7">{{ user_request.unit_transfer_new_partner_prospect_name|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Receiving PSM:" %}</dt><dd class="col-sm-7">{{ user_request.unit_transfer_receiving_partner_psm|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "New Policyholders:" %}</dt><dd class="col-sm-7 pre-wrap">{{ user_request.unit_transfer_new_policyholders|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "User Emails Provided:" %}</dt><dd class="col-sm-7">{{ unit_transfer_email_count }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "(Raw) User Emails:" %}</dt><dd class="col-sm-7 pre-wrap">{{ user_request.unit_transfer_user_email_addresses|default:"-" }}</dd> </div>
                        {% if user_request.unit_transfer_type == 'partner_to_prospect' %}
                             <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Prospect Portfolio Size:" %}</dt><dd class="col-sm-7">{{ user_request.unit_transfer_prospect_portfolio_size|default:"-" }}</dd> </div>
                             <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Prospect Landlord Type:" %}</dt><dd class="col-sm-7">{{ user_request.get_unit_transfer_prospect_landlord_type_display|default:"-" }}</dd> </div>
                             <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Proof of Sale:" %}</dt> <dd class="col-sm-7 url-break"> {% if user_request.unit_transfer_proof_of_sale %} <a href="{{ user_request.unit_transfer_proof_of_sale }}" target="_blank" rel="noopener noreferrer">{{ user_request.unit_transfer_proof_of_sale }}</a> {% else %} - {% endif %} </dd> </div>
                        {% endif %}
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Special Instructions:" %}</dt><dd class="col-sm-7 pre-wrap">{{ user_request.special_instructions|default:"-" }}</dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Uploaded File:" %}</dt> <dd class="col-sm-7"> {% if user_request.user_file %} <a href="{{ user_request.user_file.url }}" target="_blank">{{ user_request.user_file.name|cut:"user_uploads/" }}</a> {% else %} - {% endif %} </dd> </div>
                        <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Provided Link:" %}</dt> <dd class="col-sm-7 url-break"> {% if user_request.user_link %} <a href="{{ user_request.user_link }}" target="_blank">{{ user_request.user_link }}</a> {% else %} - {% endif %} </dd> </div>
                        {% if user_request.cancel_reason %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Cancel Reason:" %}</dt> <dd class="col-sm-7 pre-wrap">{{ user_request.cancel_reason|linebreaksbr }}</dd> </div> {% endif %}
                    </dl>
                </div>
            </div>

            {% if user_request.num_updated_users is not None or user_request.num_updated_properties is not None or user_request.bulk_updates is not None or user_request.manual_updated_properties is not None or user_request.manual_updated_units is not None or user_request.update_by_csv_rows is not None or user_request.processing_reports_rows is not None or user_request.operator_spreadsheet_link or user_request.operating_notes %}
                 <div class="card shadow-sm mb-4"> <div class="card-header"> {% trans "Operation Details" %} </div> <div class="card-body"> <dl> {% if user_request.num_updated_users is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Users Updated:" %}</dt> <dd class="col-sm-7">{{ user_request.num_updated_users }}</dd> </div> {% endif %} {% if user_request.num_updated_properties is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Properties Updated:" %}</dt> <dd class="col-sm-7">{{ user_request.num_updated_properties }}</dd> </div> {% endif %} {% if user_request.bulk_updates is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Bulk Updates:" %}</dt> <dd class="col-sm-7">{{ user_request.bulk_updates }}</dd> </div> {% endif %} {% if user_request.manual_updated_properties is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Manual Properties:" %}</dt> <dd class="col-sm-7">{{ user_request.manual_updated_properties }}</dd> </div> {% endif %} {% if user_request.manual_updated_units is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Manual Updated Units:" %}</dt> <dd class="col-sm-7">{{ user_request.manual_updated_units }}</dd> </div> {% endif %} {% if user_request.update_by_csv_rows is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "CSV Rows:" %}</dt> <dd class="col-sm-7">{{ user_request.update_by_csv_rows }}</dd> </div> {% endif %} {% if user_request.processing_reports_rows is not None %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Processing Reports Rows:" %}</dt> <dd class="col-sm-7">{{ user_request.processing_reports_rows }}</dd> </div> {% endif %} {% if user_request.operator_spreadsheet_link %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Operator Spreadsheet:" %}</dt> <dd class="col-sm-7 url-break"><a href="{{ user_request.operator_spreadsheet_link }}" target="_blank">{{ user_request.operator_spreadsheet_link }}</a></dd> </div> {% endif %} {% if user_request.operating_notes %} <div class="row mb-1"> <dt class="col-sm-5 text-sm-end">{% trans "Operator Notes:" %}</dt> <dd class="col-sm-7 pre-wrap">{{ user_request.operating_notes|safe }}</dd> </div> {% endif %} </dl> </div> </div>
            {% endif %}
        </div>

        {% if user.is_authenticated and user_request.status == 'completed' %}
        {% if is_admin_user or is_leadership_user %}
        {# Nueva fila para contener y centrar la tarjeta de desglose de precios #}
        <div class="row justify-content-center mt-4">
            <div class="col-lg-5 col-md-7 col-sm-10">
                <div class="card shadow-sm mb-4"> {# Tu tarjeta existente #}
                    <div class="card-header bg-success text-white"> {% trans "Price Breakdown" %} </div>
                    <div class="card-body pb-1">
                        <dl class="row">
                            {% comment %} User Update Costs {% endcomment %}
                            {% if user_request.subtotal_user_update_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "User Updates Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_user_update_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Property Update Costs {% endcomment %}
                            {% if user_request.subtotal_property_update_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Property Updates Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_property_update_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Bulk Update Costs {% endcomment %}
                            {% if user_request.subtotal_bulk_update_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Bulk Updates Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_bulk_update_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Manual Property Update Costs {% endcomment %}
                            {% if user_request.subtotal_manual_property_update_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Manual Property Updates Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_manual_property_update_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} CSV Update Costs {% endcomment %}
                            {% if user_request.subtotal_csv_update_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "CSV Updates Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_csv_update_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Processing Report Costs {% endcomment %}
                            {% if user_request.subtotal_processing_report_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Processing Reports Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_processing_report_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Manual Unit Update Costs {% endcomment %}
                            {% if user_request.subtotal_manual_unit_update_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Manual Unit Updates Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_manual_unit_update_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Address Validation Unit Costs - Específico del tipo de proceso {% endcomment %}
                            {% if user_request.type_of_process == 'address_validation' and user_request.subtotal_address_validation_unit_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Address Validation Units Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_address_validation_unit_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} Stripe Dispute Costs - Específico del tipo de proceso {% endcomment %}
                            {% if user_request.type_of_process == 'stripe_disputes' and user_request.subtotal_stripe_dispute_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "Stripe Disputes Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_stripe_dispute_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% comment %} XML File Costs - Específico del tipo de proceso {% endcomment %}
                            {% if user_request.type_of_process == 'generating_xml' and user_request.subtotal_xml_file_client_price_completed > 0 %}
                            <dt class="col-sm-8 text-sm-end">{% trans "XML Files (by carrier) Subtotal:" %}</dt>
                            <dd class="col-sm-4">${{ user_request.subtotal_xml_file_client_price_completed|floatformat:2 }}</dd>
                            {% endif %}

                            {% if user_request.grand_total_client_price_completed is not None %}
                                <hr class="my-2">
                                {# Mostrar el total antes del descuento solo si hay un descuento aplicado #}
                                {% if user_request.discount_percentage > 0 %}
                                    <dt class="col-sm-8 text-sm-end">{% trans "Grand Total (Before Discount):" %}</dt>
                                    <dd class="col-sm-4">${{ user_request.grand_total_client_price_completed|floatformat:2 }}</dd>

                                    <dt class="col-sm-8 text-sm-end text-danger">{% trans "Discount" %} ({{ user_request.discount_percentage|floatformat:"-2" }}%):</dt>
                                    <dd class="col-sm-4 text-danger">-${{ user_request.calculated_discount_amount|floatformat:2 }}</dd>

                                    <hr class="my-2">
                                    <dt class="col-sm-8 text-sm-end fw-bold">{% trans "Final Price:" %}</dt>
                                    <dd class="col-sm-4 fw-bold">${{ user_request.final_price_after_discount|floatformat:2 }}</dd>
                                {% else %}
                                    {# Si no hay descuento, mostrar solo el Grand Total como antes #}
                                    <dt class="col-sm-8 text-sm-end fw-bold">{% trans "Grand Total:" %}</dt>
                                    <dd class="col-sm-4 fw-bold">${{ user_request.grand_total_client_price_completed|floatformat:2 }}</dd>
                                {% endif %}
                            {% endif %}
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}

    </div>

    {# --- Sección: Historial de Acciones --- #}
     <div class="row g-4">
        {% if blocked_history %} <div class="col-md-4"> <h4 class="h5">{% trans "Block History" %}</h4> <ul class="list-group list-group-flush"> {% for block in blocked_history %} <li class="list-group-item small"> <span class="text-muted"> {% timezone request.user.timezone|default:"UTC" %}{{ block.blocked_at|date:"Y-m-d H:i:s" }}{% endtimezone %} {% trans "by" %} {{ block.blocked_by.email|default:"Unknown" }}: </span><br> {{ block.reason|safe }} </li> {% endfor %} </ul> </div> {% endif %}
        {% if resolved_history %} <div class="col-md-4"> <h4 class="h5">{% trans "Resolution History" %}</h4> <ul class="list-group list-group-flush"> {% for resolve in resolved_history %} <li class="list-group-item small"> <span class="text-muted"> {% timezone request.user.timezone|default:"UTC" %}{{ resolve.resolved_at|date:"Y-m-d H:i:s" }}{% endtimezone %} {% trans "by" %} {{ resolve.resolved_by.email|default:"Unknown" }}: </span><br> {{ resolve.message|linebreaksbr }} {% if resolve.resolved_file %}<br><small><a href="{{ resolve.resolved_file.url }}" target="_blank">{% trans "View File" %}</a></small>{% endif %} {% if resolve.resolved_link %}<br><small><a href="{{ resolve.resolved_link }}" target="_blank">{% trans "View Link" %}</a></small>{% endif %} </li> {% endfor %} </ul> </div> {% endif %}
        {% if rejected_history %} <div class="col-md-4"> <h4 class="h5">{% trans "Rejection History" %}</h4> <ul class="list-group list-group-flush"> {% for reject in rejected_history %} <li class="list-group-item small"> <span class="text-muted"> {% timezone request.user.timezone|default:"UTC" %}{{ reject.rejected_at|date:"Y-m-d H:i:s" }}{% endtimezone %} {% trans "by" %} {{ reject.rejected_by.email|default:"Unknown" }}: </span><br> {{ reject.reason|linebreaksbr }} {% if reject.is_resolved_qa %}<span class="badge bg-info-subtle text-info-emphasis border border-info-subtle rounded-pill ms-1">{% trans "Resolved by QA" %}</span>{% endif %} </li> {% endfor %} </ul> </div> {% endif %}
    </div>

    {# --- Sección: Botones de Acción (Lógica de visibilidad igual a user_records_detail.html) --- #}
    <div class="mt-4 pt-3 border-top">
        <h4 class="h5 mb-3">{% trans "Actions" %}</h4>
        <form method="post" style="display: inline-block; margin-right: 5px;"> {% csrf_token %}
             {% if is_agent_user %}
                {# Botón Operate: solo para 'pending' #}
                {% if user_request.status == 'pending' %}
                    <button type="submit" formaction="{% url 'tasks:operate_request' user_request.id %}" class="btn btn-primary btn-sm me-1 mb-1"><i class="bi bi-play-fill me-1"></i>Operate</button>
                {% endif %}
                {# Botón Block: para 'pending' O 'in_progress' (para cualquier agente) #}
                {% if user_request.status == 'pending' or user_request.status == 'in_progress' %}
                    <a href="#blockFormModal_ut" data-bs-toggle="modal" class="btn btn-warning btn-sm me-1 mb-1"><i class="bi bi-lock-fill me-1"></i>{% trans "Block" %}</a>
                {% endif %}
                {# Botón Send to QA: solo para 'in_progress' y si el usuario actual es el operador #}
                {% if user_request.status == 'in_progress' and user_request.operator == request.user %}
                    <a href="#operateFormModal_ut" data-bs-toggle="modal" data-form-action="{% url 'tasks:send_to_qa_request' user_request.id %}" class="btn btn-info btn-sm me-1 mb-1"><i class="bi bi-send-check me-1"></i>Send to QA</a>
                {% endif %}
                {# Botón Start QA: solo para 'qa_pending' #}
                {% if user_request.status == 'qa_pending' %}
                    <button type="submit" formaction="{% url 'tasks:qa_request' user_request.id %}" class="btn btn-primary btn-sm me-1 mb-1"><i class="bi bi-search me-1"></i>Start QA</button>
                {% endif %}
                {# Botón Complete: solo para 'qa_in_progress' y si el usuario actual es el qa_agent #}
                {% if user_request.status == 'qa_in_progress' and user_request.qa_agent == request.user %}
                    <a href="#completeFormModal_ut" data-bs-toggle="modal" data-form-action="{% url 'tasks:complete_request' user_request.id %}" class="btn btn-success btn-sm me-1 mb-1"><i class="bi bi-check-circle-fill me-1"></i>Complete</a>
                {% endif %}
                {# Botón Update Provided #}
                {% if can_provide_update %}
                    {% if user_request.status == 'pending' or user_request.status == 'in_progress' or user_request.status == 'qa_pending' or user_request.status == 'qa_in_progress' %}
                        <a href="#provideUpdateModal" data-bs-toggle="modal" class="btn btn-outline-success btn-sm me-1 mb-1" title='{% trans "Provide an update message and clear the flag" %}'><i class="bi bi-chat-left-text-fill me-1"></i>{% trans "Provide Update" %}</a>
                    {% endif %}
                {% endif %}
                {# Botón Unassign #}
                {% if can_unassign %}
                    <button type="submit"
                            formaction="{% url 'tasks:unassign_agent' user_request.id %}"
                            class="btn btn-outline-secondary btn-sm me-1 mb-1"
                            onclick="return confirm('Are you sure you want to unassign from this request? It will be returned to the previous pending queue.');"
                            title="{% trans 'Unassign yourself from this task and return it to the queue' %}">
                        <i class="bi bi-person-x-fill me-1"></i>{% trans "Unassign" %}
                    </button>
                {% endif %}
            {% endif %}
            {% if user_request.type_of_process == 'unit_transfer' and user_request.status == 'pending_approval' and is_leadership_user %} <button type="submit" formaction="{% url 'tasks:approve_deactivation_toggle' user_request.id %}" class="btn btn-success btn-sm me-1 mb-1"><i class="bi bi-check-lg me-1"></i>{% trans "Approve" %}</button> {% endif %}
            {% if user_request.status == 'blocked' %} <a href="#resolveFormModal_ut" data-bs-toggle="modal" class="btn btn-success btn-sm me-1 mb-1"><i class="bi bi-unlock-fill me-1"></i>{% trans "Resolve" %}</a> {% endif %}
            {% if can_reject_request %} <a href="#rejectFormModal_ut" data-bs-toggle="modal" class="btn btn-danger btn-sm me-1 mb-1"><i class="bi bi-x-octagon-fill me-1"></i>{% trans "Reject" %}</a> {% endif %}
            {% if can_request_update_action %}
                {% if user_request.status == 'pending' or user_request.status == 'in_progress' or user_request.status == 'qa_pending' or user_request.status == 'qa_in_progress' %}
                    <button type="submit" formaction="{% url 'tasks:set_update_flag' user_request.id %}" class="btn btn-outline-info btn-sm me-1 mb-1" title="Notify the agent you are looking for an update on this task"><i class="bi bi-bell me-1"></i>Request Update</button>
                {% endif %}
            {% endif %}
            {% if can_cancel_request %}
                 <button type="submit" formaction="{% url 'tasks:cancel_request' user_request.id %}" class="btn btn-secondary btn-sm me-1 mb-1" onclick="return confirm('{% trans "Are you sure you want to cancel this request?" %}');"><i class="bi bi-stop-circle-fill me-1"></i>{% trans "Cancel Request" %}</button>
            {% endif %}
            {% if can_uncancel_request %}
                 <button type="submit" formaction="{% url 'tasks:uncancel_request' user_request.id %}" class="btn btn-outline-warning btn-sm me-1 mb-1" onclick="return confirm('{% trans "Are you sure you want to uncancel this request and return it to Pending?" %}');"><i class="bi bi-arrow-counterclockwise me-1"></i>{% trans "Uncancel" %}</button>
            {% endif %}
        </form>
        <a href="{% url 'tasks:rhino_dashboard' %}" class="btn btn-outline-secondary btn-sm ms-2 mb-1">{% trans "Back to Dashboard" %}</a>
    </div>

</div>

{# --- Modales (igual que en user_records_detail.html, con IDs actualizados con sufijo _ut) --- #}
{# (blockFormModal, resolveFormModal, rejectFormModal, operateFormModal, completeFormModal) #}
<div class="modal fade" id="blockFormModal_ut" tabindex="-1" aria-labelledby="blockFormModalLabel_ut" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'tasks:block_request' user_request.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="blockFormModalLabel_ut">{% trans "Block Request" %}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                </div>
                <div class="modal-body">
                    <p>{% trans "Please provide the reason for blocking this request." %}</p>
                    {{ block_form.as_p }}
                    {{ block_form.media }}
                </div>
                <button type="button" class="btn btn-info btn-sm mt-2 js-toggle-tinymce">Rich Text</button>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                    <button type="submit" class="btn btn-warning">{% trans "Block Request" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="resolveFormModal_ut" tabindex="-1" aria-labelledby="resolveFormModalLabel_ut" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <form method="post" action="{% url 'tasks:resolve_request' user_request.id %}" enctype="multipart/form-data"> {% csrf_token %} <div class="modal-header"> <h1 class="modal-title fs-5" id="resolveFormModalLabel_ut">{% trans "Resolve Request" %}</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button> </div> <div class="modal-body"> <div class="mb-3"> <label for="id_message_resolve_ut" class="form-label">{% trans "Resolution Message" %} <span class="text-danger">*</span></label> <textarea name="message" class="form-control" id="id_message_resolve_ut" rows="3" required></textarea> </div> <div class="mb-3"> <label for="id_resolved_file_ut" class="form-label">{% trans "Upload Resolution File (optional)" %}</label> <input type="file" name="resolved_file" class="form-control form-control-sm" id="id_resolved_file_ut"> </div> <div class="mb-3"> <label for="id_resolved_link_ut" class="form-label">{% trans "Provide Resolution Link (optional)" %}</label> <input type="url" name="resolved_link" class="form-control form-control-sm" id="id_resolved_link_ut" placeholder="https://..."> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button> <button type="submit" class="btn btn-success">{% trans "Resolve Request" %}</button> </div> </form> </div> </div> </div>
<div class="modal fade" id="rejectFormModal_ut" tabindex="-1" aria-labelledby="rejectFormModalLabel_ut" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <form method="post" action="{% url 'tasks:reject_request' user_request.id %}"> {% csrf_token %} <div class="modal-header"> <h1 class="modal-title fs-5" id="rejectFormModalLabel_ut">{% trans "Reject Request" %}</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button> </div> <div class="modal-body"> <div class="mb-3"> <label for="id_reason_reject_ut" class="form-label">{% trans "Reason for Rejection" %} <span class="text-danger">*</span></label> <textarea name="reason" class="form-control" id="id_reason_reject_ut" rows="3" required></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button> <button type="submit" class="btn btn-danger">{% trans "Reject Request" %}</button> </div> </form> </div> </div> </div>
<div class="modal fade" id="operateFormModal_ut" tabindex="-1" aria-labelledby="operateFormModalLabel_ut" aria-hidden="true"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <form id="operate-form-ut" method="post" action="{% url 'tasks:send_to_qa_request' user_request.id %}"> {% csrf_token %} <div class="modal-header"> <h1 class="modal-title fs-5" id="operateFormModalLabel_ut">{% trans "Enter Operation Details (Send to QA)" %}</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-4 mb-3"> <label for="id_num_updated_users_op_ut" class="form-label small"> {% trans "Users Updated/Added/Removed" %} </label> <input type="number" name="num_updated_users" value="{% firstof prefill_user_count user_request.num_updated_users '' %}" min="0" class="form-control form-control-sm" id="id_num_updated_users_op_ut"> <div class="invalid-feedback" id="error-num_updated_users_op_ut" style="display: none;">{% trans "This field is required for User Records (0 is valid)." %}</div> </div> <div class="col-md-4 mb-3"> <label for="id_num_updated_properties_op_ut" class="form-label small"> {% trans "Properties Updated" %} <span class="text-danger">*</span> </label> <input type="number" name="num_updated_properties" value="{{ user_request.num_updated_properties|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_num_updated_properties_op_ut"> <div class="invalid-feedback" id="error-num_updated_properties_op_ut" style="display: none;">{% trans "This field is required (0 is valid)." %}</div> </div> <div class="col-md-4 mb-3"> <label for="id_bulk_updates_op_ut" class="form-label small">{% trans "Bulk Updates (Count)" %}</label> <input type="number" name="bulk_updates" value="{{ user_request.bulk_updates|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_bulk_updates_op_ut"> </div> <div class="col-md-4 mb-3"> <label for="id_manual_updated_properties_op_ut" class="form-label small">{% trans "Manual Property Updates (Count)" %}</label> <input type="number" name="manual_updated_properties" value="{{ user_request.manual_updated_properties|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_manual_updated_properties_op_ut"> </div> <div class="col-md-4 mb-3"> <label for="id_manual_updated_units_op_ut" class="form-label small">{% trans "Manual Updated Units (Count)" %}</label> <input type="number" name="manual_updated_units" value="{{ user_request.manual_updated_units|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_manual_updated_units_op_ut"> </div> <div class="col-md-4 mb-3"> <label for="id_update_by_csv_rows_op_ut" class="form-label small">{% trans "CSV Rows Processed" %}</label> <input type="number" name="update_by_csv_rows" value="{{ user_request.update_by_csv_rows|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_update_by_csv_rows_op_ut"> </div> <div class="col-md-4 mb-3"> <label for="id_processing_reports_rows_op_ut" class="form-label small">{% trans "Report Rows Processed" %}</label> <input type="number" name="processing_reports_rows" value="{{ user_request.processing_reports_rows|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_processing_reports_rows_op_ut"> </div> </div> <div class="mb-3"> <label for="id_operator_spreadsheet_link_op_ut" class="form-label small">{% trans "Operator Spreadsheet Link (Optional)" %}</label> <input type="url" name="operator_spreadsheet_link" value="{{ user_request.operator_spreadsheet_link|default:'' }}" class="form-control form-control-sm" id="id_operator_spreadsheet_link_op_ut" placeholder="https://docs.google.com/spreadsheets/..."> </div> <div class="mb-3"> {{ operate_form.operating_notes.label_tag }} {{ operate_form.operating_notes }} </div> <button type="button" class="btn btn-info btn-sm mt-2 js-toggle-tinymce">Rich Text</button> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button> <button type="submit" class="btn btn-info">{% trans "Send to QA" %}</button> </div> </form> </div> </div> </div>
<div class="modal fade" id="completeFormModal_ut" tabindex="-1" aria-labelledby="completeFormModalLabel_ut" aria-hidden="true"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <form id="complete-form-ut" method="post" action="{% url 'tasks:complete_request' user_request.id %}"> {% csrf_token %} <div class="modal-header"> <h1 class="modal-title fs-5" id="completeFormModalLabel_ut">{% trans "Confirm Operation Details (Complete Request)" %}</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-4 mb-3"> <label for="id_num_updated_users_comp_ut" class="form-label small"> {% trans "Users Updated/Added/Removed" %} </label> <input type="number" name="num_updated_users" value="{% firstof prefill_user_count user_request.num_updated_users '' %}" min="0" class="form-control form-control-sm" id="id_num_updated_users_comp_ut"> <div class="invalid-feedback" id="error-num_updated_users_comp_ut" style="display: none;">{% trans "This field is required for User Records (0 is valid)." %}</div> </div> <div class="col-md-4 mb-3"> <label for="id_num_updated_properties_comp_ut" class="form-label small"> {% trans "Properties Updated" %} <span class="text-danger">*</span> </label> <input type="number" name="num_updated_properties" value="{{ user_request.num_updated_properties|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_num_updated_properties_comp_ut"> <div class="invalid-feedback" id="error-num_updated_properties_comp_ut" style="display: none;">{% trans "This field is required (0 is valid)." %}</div> </div> <div class="col-md-4 mb-3"><label for="id_bulk_updates_comp_ut" class="form-label small">{% trans "Bulk Updates (Count)" %}</label><input type="number" name="bulk_updates" value="{{ user_request.bulk_updates|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_bulk_updates_comp_ut"></div> <div class="col-md-4 mb-3"><label for="id_manual_updated_properties_comp_ut" class="form-label small">{% trans "Manual Property Updates (Count)" %}</label><input type="number" name="manual_updated_properties" value="{{ user_request.manual_updated_properties|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_manual_updated_properties_comp_ut"></div> <div class="col-md-4 mb-3"><label for="id_manual_updated_units_comp_ut" class="form-label small">{% trans "Manual Updated Units (Count)" %}</label><input type="number" name="manual_updated_units" value="{{ user_request.manual_updated_units|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_manual_updated_units_comp_ut"></div> <div class="col-md-4 mb-3"><label for="id_update_by_csv_rows_comp_ut" class="form-label small">{% trans "CSV Rows Processed" %}</label><input type="number" name="update_by_csv_rows" value="{{ user_request.update_by_csv_rows|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_update_by_csv_rows_comp_ut"></div> <div class="col-md-4 mb-3"><label for="id_processing_reports_rows_comp_ut" class="form-label small">{% trans "Report Rows Processed" %}</label><input type="number" name="processing_reports_rows" value="{{ user_request.processing_reports_rows|default_if_none:'' }}" min="0" class="form-control form-control-sm" id="id_processing_reports_rows_comp_ut"></div> </div> <div class="mb-3"> <label for="id_operator_spreadsheet_link_comp_ut" class="form-label small">{% trans "Operator Spreadsheet Link (Optional)" %}</label> <input type="url" name="operator_spreadsheet_link" value="{{ user_request.operator_spreadsheet_link|default:'' }}" class="form-control form-control-sm" id="id_operator_spreadsheet_link_comp_ut" placeholder="https://docs.google.com/spreadsheets/..."> </div> <div class="mb-3"> {{ operate_form.operating_notes.label_tag }} {{ operate_form.operating_notes }} </div> <button type="button" class="btn btn-info btn-sm mt-2 js-toggle-tinymce">Rich Text</button> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button> <button type="submit" class="btn btn-success">{% trans "Complete Request" %}</button> </div> </form> </div> </div> </div>
<div class="modal fade" id="provideUpdateModal" tabindex="-1" aria-labelledby="provideUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'tasks:clear_update_flag' user_request.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="provideUpdateModalLabel">{% trans "Provide Update Message" %}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_provide_update_message" class="form-label">{% trans "Update Message" %} <span class="text-danger">*</span></label>
                        <textarea name="update_message" class="form-control" id="id_provide_update_message" rows="5" required></textarea>
                        {# Para mostrar errores del formulario si los hubiera, aunque es más simple manejar con messages framework #}
                        {# {% if provide_update_form.update_message.errors %} #}
                        {# <div class="invalid-feedback d-block">{{ provide_update_form.update_message.errors|join:", " }}</div> #}
                        {# {% endif %} #}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Send Update" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{# El script de validación JS para los modales es el mismo que antes, adaptado para Unit Transfer (solo propiedades es mandatorio) #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modals = ['operateFormModal', 'completeFormModal'];
        // const currentRequestType = "{{ user_request.type_of_process|escapejs }}"; // No es necesario para la validación de modal aquí

        modals.forEach(modalId => {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;

            const form = modalElement.querySelector('form'); // IDs de form son únicos por sufijo _ut
            const submitButton = form ? form.querySelector('button[type="submit"]') : null;
            if (!form || !submitButton) return;

            const suffix = (modalId === 'operateFormModal') ? '_op_ut' : '_comp_ut';

            // const usersUpdatedInput = form.querySelector('#id_num_updated_users' + suffix); // No se valida obligatoriamente para UT
            const propertiesUpdatedInput = form.querySelector('#id_num_updated_properties' + suffix);
            // const usersErrorDiv = form.querySelector('#error-num_updated_users' + suffix);
            const propsErrorDiv = form.querySelector('#error-num_updated_properties' + suffix);

             function validateRequiredNumericField(inputElement, errorDiv, errorMessage) {
                if (!inputElement) { return true;}
                if (!errorDiv) { console.warn("validateRequiredNumericField: errorDiv is null for input:", inputElement); return true;}

                 inputElement.classList.remove('is-invalid');
                 errorDiv.style.display = 'none';
                 const value = inputElement.value.trim();

                 if (value === '') {
                     inputElement.classList.add('is-invalid');
                     errorDiv.textContent = errorMessage || "{% trans 'This field is required (0 is valid).' %}";
                     errorDiv.style.display = 'block';
                     return false;
                 }
                 const numValue = parseInt(value, 10);
                 if (isNaN(numValue) || numValue < 0) {
                      inputElement.classList.add('is-invalid');
                      errorDiv.textContent = "{% trans 'Please enter a valid number (0 or greater).' %}";
                      errorDiv.style.display = 'block';
                      return false;
                 }
                 return true;
             }

            function clearValidationErrors() {
                // if(usersUpdatedInput) usersUpdatedInput.classList.remove('is-invalid'); // No se valida aquí
                if(propertiesUpdatedInput) propertiesUpdatedInput.classList.remove('is-invalid');
                // if(usersErrorDiv) usersErrorDiv.style.display = 'none';
                if(propsErrorDiv) propsErrorDiv.style.display = 'none';
            }

            modalElement.addEventListener('show.bs.modal', clearValidationErrors);
            if (modalElement.classList.contains('show')) { clearValidationErrors(); }


            form.addEventListener('submit', function(event) {
                let isFormValid = true;
                if (!validateRequiredNumericField(propertiesUpdatedInput, propsErrorDiv, "{% trans 'Properties Updated is required (0 is valid).' %}")) {
                     isFormValid = false;
                }

                if (!isFormValid) {
                    event.preventDefault();
                    event.stopPropagation();
                } else {
                     if(submitButton){
                        submitButton.disabled = true;
                        submitButton.textContent = '{% trans "Processing..." %}';
                     }
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        const completeModal = document.getElementById('completeFormModal_av');
        const newEditorId = 'complete-notes-editor';
        let completeTextarea = null;

        if (completeModal) {
            completeTextarea = completeModal.querySelector('.tinymce-target');
            if (completeTextarea) {
                completeTextarea.id = newEditorId;
            }
        }

        // 1. Lógica para activar el editor en 'Complete' si tiene HTML
        if (completeTextarea) {
            const content = completeTextarea.value;
            if (content.includes('<') && content.includes('>')) {
                const button = completeModal.querySelector('.js-toggle-tinymce');
                if (button) {
                    // Usamos el NUEVO ID único para inicializar
                    initializeTinyMce(newEditorId);
                    button.textContent = 'Plain Text';
                }
            }
        }

        // 2. Lógica universal para TODOS los botones de toggle
        const toggleButtons = document.querySelectorAll('.js-toggle-tinymce');
        toggleButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const wrapperDiv = event.target.previousElementSibling;
                const textarea = wrapperDiv.querySelector('.tinymce-target');
                if (!textarea) return;

                // La lógica ahora funcionará porque el ID del textarea 'Complete' ya es único.
                const editorId = textarea.id;

                if (tinymce.get(editorId)) {
                    tinymce.get(editorId).remove();
                    button.textContent = 'Rich Text';
                } else {
                    initializeTinyMce(editorId);
                    button.textContent = 'Plain Text';
                }
            });
        });

        // 3. Lógica para limpiar los modales al cerrarse (sigue igual)
        const allModals = document.querySelectorAll('.modal');
        allModals.forEach(modal => {
            modal.addEventListener('hidden.bs.modal', (event) => {
                const textarea = modal.querySelector('.tinymce-target');
                if (!textarea) return;

                const editor = tinymce.get(textarea.id);
                if (editor) {
                    editor.remove();
                    const button = modal.querySelector('.js-toggle-tinymce');
                    if (button) button.textContent = 'Rich Text';
                }
            });
        });
    });
</script>
{% endblock extra_js %}